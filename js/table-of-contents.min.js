!function(){function getHigherTitle(contentNode){var capturedTitles,index,titles=["h1","h2","h3","h4","h5","h6"],higherTitle=!1;for(index=0;index<titles.length;index++)if(capturedTitles=contentNode.getElementsByTagName(titles[index]),capturedTitles.length>0){higherTitle=titles[index];break}return higherTitle=higherTitle.toLowerCase().replace("h","")}function createTable(contentNode,depth,indentation,tableClass,higherTitle,addLinks){var capturedTitles,currentTitle,index,titleIndex,orderedTitles,titleIndex,generatedIndentation,linkLocation,originalId,tableLine,titleValue,table,titles=[],className="tinymce-table-of-contents";for(index=0;index<depth;index++)titles.push("h"+(parseInt(higherTitle)+parseInt(index)));for(index=0;index<titles.length;index++)for(capturedTitles=contentNode.getElementsByTagName(titles[index]),titleIndex=0;titleIndex<capturedTitles.length;titleIndex++)currentTitle=capturedTitles[titleIndex],currentTitle.className+=" "+className;for(orderedTitles=contentNode.getElementsByClassName(className),table='<div class="tinymce-table-of-contents '+tableClass+'">',index=0;index<orderedTitles.length;index++)titleIndex=orderedTitles[index].tagName.toLowerCase().replace("h",""),titleValue=orderedTitles[index].innerHTML.replace("<br>",""),generatedIndentation=generateIndentation(higherTitle,titleIndex,indentation),addLinks?(originalId=orderedTitles[index].id,""===originalId?(linkLocation=createLink(higherTitle,titleIndex,index+1),addIdToTitle(linkLocation,"h"+titleIndex.toString(),titleValue),linkLocation='<a href="'+linkLocation+'">'):linkLocation='<a href="'+originalId+'">',tableLine=generatedIndentation+linkLocation+titleValue+"</a><br>"):tableLine=generatedIndentation+titleValue+"<br>",table+=tableLine;return table+="</div>"}function generateIndentation(higherTitle,currentTitle,indentationLevel){var depth,index,indentation="";for(depth=currentTitle-higherTitle,index=0;index<depth*indentationLevel;index++)indentation+="&nbsp;";return indentation='<span style="white-space: pre;">'+indentation+"</span>"}function createLink(higherTitleIndex,currentTitleIndex){var sectionIndex,link,isTopSection,index;for(sectionIndex=currentTitleIndex-higherTitleIndex,void 0===_sectionsCounter[sectionIndex]||null===_sectionsCounter[sectionIndex]?_sectionsCounter[sectionIndex]=1:_sectionsCounter[sectionIndex]++,link="#section_",index=0;index<=sectionIndex;index++)link+=_sectionsCounter[index]+"_";if(link=link.slice(0,-1),isTopSection=0===sectionIndex)for(index=1;index<_sectionsCounter.length;index++)_sectionsCounter[index]=null;return link}function addIdToTitle(location,titleTag,titleValue){var id,documentTitles,index,titleNode,titleNodeValue,editorDocument=tinyMCE.activeEditor.getBody();for(id=location.substring(1),documentTitles=editorDocument.getElementsByTagName(titleTag),index=0;index<documentTitles.length;index++)if(titleNode=documentTitles[index],titleNodeValue=titleNode.innerHTML.replace("<br>",""),titleNodeValue===titleValue&&""===titleNode.id){titleNode.id=id;break}}var _sectionsConcat="",_sectionsCounter=[];tinymce.PluginManager.add("table_of_contents",function(editor,url){editor.addButton("table_of_contents",{title:"Table of contents",cmd:"table_of_contents",image:url+"/../img/table-of-contents.png"}),editor.addCommand("table_of_contents",function(){editor.windowManager.open({title:"Table of contents",body:[{type:"textbox",name:"depth",label:"Table depth",value:"2"},{type:"textbox",name:"indentation",label:"Indentation ( in spaces )",value:"4"},{type:"textbox",name:"table_class",label:"Table class",value:"toc"},{type:"checkbox",name:"add_links",label:"Add links to sections",checked:!0}],onsubmit:function(e){var contentNode,higherTitle,table,depth=e.data.depth,indentation=e.data.indentation,tableClass=e.data.table_class,addLinks=e.data.add_links;contentNode=document.createElement("html"),contentNode.innerHTML=tinyMCE.activeEditor.getContent({format:"raw"}),higherTitle=getHigherTitle(contentNode),table=createTable(contentNode,depth,indentation,tableClass,higherTitle,addLinks),editor.insertContent(table),_sectionsConcat="",_sectionsCounter=[]}})})})}();